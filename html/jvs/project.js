"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};sky.service("actions",["exceptions"],function(_ref){var exceptions=_ref.exceptions,list={},actions=this.service={perform:function perform(element,event,action,options){var params=action.match(/(.+)\((.*)\)/);params&&(action=params[1],params=params[2].split(","),$.each(params,function(i,val){params[i]=eval(val.trim())})),options&&(params=$.extend(params||[],options));var self=!!element&&$(element),path=action.split("."),current=list,name=action;if(!(self&&self.isDisabled&&self.isDisabled())){if($.each(path,function(i,elem){if(i+1<path.length&&!current[elem])throw new exceptions.system.Error("No action - "+action+", because can't find '"+elem+"'");i+1<path.length&&(current=current[elem]),name=elem}),!current[name])throw new exceptions.system.Error("No action - "+action);current[name].apply(current,[self,event].concat(params||[]))}},add:function(name,events){if("function"==typeof events&&(events=events.safe(!0)()),!events||"object"!==(void 0===events?"undefined":_typeof(events)))throw new exceptions.system.Error("No event object for events '"+name+"' provided");list[name]=$.extend(list[name]||{},events)}};$.fn.action=function(name,selector,action){return void 0===action&&(action=selector,selector=null),this.on(name,selector,function(event,data){action.call(this,event,$(this),data)}.safe())},$(document).action("click submit keyup keydown dblclick mouseover mouseout mouseleave mouseenter change mousedown mouseup touchstart","[data-event]",function(event,self,data){var _this=this,skyEvent=this.getAttribute("data-event");-1!==skyEvent.indexOf(event.type)&&(self.isDisabled&&self.isDisabled()?event.preventDefault():skyEvent.split(";").map(function(eventString){var parts=eventString.match(/(\w+):(.*)/);if(3!==parts.length)throw new exceptions.system.Error("Wrong action format in data-event: "+eventString);var name=parts[1].trim(),action=parts[2].trim();name===event.type&&(event.target===self.get(0)&&event.preventDefault(),event.data=data,actions.perform(_this,event,action))}))})}),sky.service("ajax",["callbacks"],function(_ref){var callbacks=_ref.callbacks;this.service=function(url,data,_ref2){var _ref2$object=_ref2.object,object=void 0===_ref2$object?null:_ref2$object,_ref2$callbackData=_ref2.callbackData,callbackData=void 0===_ref2$callbackData?{}:_ref2$callbackData,_ref2$ajaxExtend=_ref2.ajaxExtend,ajaxExtend=void 0===_ref2$ajaxExtend?{}:_ref2$ajaxExtend;object&&(object=$(object).filter(":not(.disabled)").disable());var ajaxCallbacks=new callbacks;return ajaxCallbacks.stop=function(){ajaxCallbacks.ajax.abort()},ajaxCallbacks.ajax=$.ajax($.extend(!0,{url:url,data:data,dataType:"json",type:"post",timeout:48e4,success:function(response,textStatus,jqXHR){var params=$.extend({jqXHR:jqXHR,textStatus:textStatus,object:object},callbackData);return null===response&&(params.error="Данные небыли переданы",params.type="noData"),response.error&&(params.error=response.text,params.type="php"),params.type?ajaxCallbacks.fire("notSuccess, error",params):(params.response=params.data=response,ajaxCallbacks.fire("preSuccess, success, notAbort",params))}.safe(),error:function(jqXHR,textStatus,errorThrown){var type="Unknown",errorText="Во время выполнения запроса произошла ошибка, пожалуйста попробуйте позже";"abort"===textStatus?(type="abort",errorText="Выполнение запроса прервано"):"parsererror"===textStatus?(type="parse",errorText="Ответ пришел в неверном формате, пожалуйста попробуйте позже, текст:<br/>"+jqXHR.responseText):"timeout"===textStatus?(type="timeout",errorText="Время ожидания ответа истекло"):0===jqXHR.status?(type="stopped",errorText="Загрузка остановлена, проверьте свои настройки сети"):codes[jqXHR.status]&&(type=jqXHR.status,errorText="Ошибка во времы выполнения запроса <br/> "+codes[jqXHR.status]);var params=$.extend({error:errorText,type:type,code:type,jqXHR:jqXHR,textStatus:textStatus,status:textStatus,errorThrown:errorThrown,object:object},callbackData);ajaxCallbacks.fire("notSuccess",params),ajaxCallbacks.fire("abort"===textStatus?"abort":"error, notAbort",params)}.safe()},ajaxExtend)),ajaxCallbacks.ajax.promise().always(function(jqXHR,textStatus,errorThrown){object&&object.enable(),ajaxCallbacks.fire("always",{errorThrown:errorThrown,textStatus:textStatus,jqXHR:jqXHR,object:object})}.safe()),ajaxCallbacks};var codes={400:"Неверный запрос",401:"Для выполнеия запроса нужня авторизация",402:"Для доступа к ресурсу необходима оплата",403:"Доступ к ресурсу запрещен",404:"Сервер для выполнения запроса не найден или запрос выполнялся слишком долго",405:"Не поддерживаемый метод HTTP",406:"Не приемлемо",407:"Необходима аутентификация прокси",408:"Истекло время ожидания",409:"Конфликт",410:"Ресурс удален",411:"В запросе не указана длинна",412:"Условие ложно",413:"Размер запроса слишком велик",414:"Запрашиваемый URI слишком длинный",415:"Неподдерживаемый тип данных",416:"Запрашиваемый диапазон не достижим",417:"Ожидаемое неприемлемо",422:"Необрабатываемый экземпляр",423:"Ресурс заблокирован",424:"Невыполненная зависимость",425:"Неупорядоченный набор",426:"Необходимо обновление",428:"Необходимо предусловие",429:"Слишком много запросов",431:"Поля заголовка запроса слишком большие",451:"Недоступно по юридическим причинам",456:"Некорректируемая ошибка",499:"Используется Nginx, соединение закрыто до получения ответа",500:"Внутренняя ошибка сервера",501:"Не реализовано",502:"Плохой или ошибочный шлюз",503:"Сервис недоступен",504:"Шлюз не отвечает",505:"Версия HTTP не поддерживается",506:"Вариант тоже проводит согласование",507:"Переполнение хранилища",508:"Запрос зациклен",509:"Исчерпана пропускная ширина канала",510:"Не расширено",511:"Требуется сетевая аутентификация"}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("ajaxFilesDropZone",["supported","callbacks"],function(_ref){var supported=_ref.supported,callbacks=_ref.callbacks;this.service=function(){function _class(_ref2){var zone=_ref2.zone,data=_ref2.data,url=_ref2.url,options=_ref2.options;if(_classCallCheck(this,_class),this.options=options,this.zone=zone,this.callbacks=callbacks(),this.data=data,this.url=url,this.files=[],!supported.XHRIsSupported)return this.callbacks.fire("nonSupported"),this;this.attachEvents()}return _createClass(_class,[{key:"attachEvents",value:function(){var _this=this;this.zone.on({dragenter:function(event){_this.callbacks.fire("dragenter",_this,[event])},dragleave:function(event){_this.callbacks.fire("dragleave",_this,[event])},dragend:function(event){_this.callbacks.fire("dragend",_this,[event])},drop:function(event){_this.callbacks.fire("drop",_this,[event])},dragover:function(event){if(event=event.originalEvent,_this.isValidFileDrag(event)){var effect=event.dataTransfer.effectAllowed;event.dataTransfer.dropEffect="move"===effect||"linkMove"===effect?"move":"copy",event.preventDefault()}}}),$(document).bind({dragover:function(e){(e=e.originalEvent).dataTransfer&&(e.dataTransfer.dropEffect="none",e.preventDefault())},dragenter:function(e){void 0!==self.options.onStart&&self.options.onStart.apply(self,[e])}})}}],[{key:"isValidFileDrag",value:function(event){var dt=event.dataTransfer,isWebkit=-1<navigator.userAgent.indexOf("AppleWebKit");return dt&&"none"!==dt.effectAllowed&&(dt.files||!isWebkit&&dt.types.contains&&dt.types.contains("Files"))}}]),_class}()}),sky.service("ajaxFilesIFrame",function(){}),sky.service("ajaxFiles",["supported","callbacks","ajaxFilesXHR","ajaxFilesIFrame"],function(_ref){var callbacks=_ref.callbacks,supported=_ref.supported,ajaxFilesXHR=_ref.ajaxFilesXHR,ajaxFilesIFrame=_ref.ajaxFilesIFrame,AjaxFiles=this.service=function(input,url,data){return this instanceof AjaxFiles?(this.inputs=$(input),this.url=url,this.data=data,this.callbacks=callbacks(),this.files=[],this.saveFiles=function(input){if(supported.XHRUpload){var files=input.get(0).files,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=files[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var file=_step.value;this.files.push({file:file,input:input,inputName:input.attr("name")})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else this.files.push(input.get(0))},this.send=function(parallel){var _this=this;if(this.files=[],this.inputs.each(function(_,input){_this.saveFiles($(input))}),!this.files.length)return!1;var handler=void 0;return handler=supported.XHRUpload?new ajaxFilesXHR(this):new ajaxFilesIFrame(this),parallel?this.sendParallel(handler):this.sendConsequentially(handler),handler},this.sendConsequentially=function(handler){var _this2=this,id=0;this.callbacks.on("always",function(){id++,_this2.files[id]&&handler.send(_this2.files[id])}),handler.send(self.files[id])},this.sendParallel=function(handler){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this.files[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var file=_step2.value;handler.send(file)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}},this):new AjaxFiles(input,url,data)};AjaxFiles.defaultSend=function(url,element,data){var input=element.is("input[type=file]")?element:element.closest("label, .label").find("input[type=file]"),exceptions=sky.service("exceptions"),templates=sky.service("templates"),notifications=sky.service("notifications"),windows=sky.service.windows("windows");if(!input.length)throw new exceptions.system.Error("No proper input provided for file send");var filesAjax=AjaxFiles(input,url,data),modal=windows.getLast(),currentFile=void 0;return filesAjax.callbacks.on("begin",function(file){modal&&(modal.holder.find(".preview").remove(),modal.lock()),currentFile=templates.render("files-single-upload",file).insertAfter(element.parent())}).on("always",function(){currentFile.remove(),modal&&modal.unlock()}).on("notSuccess",function(error){modal.clearExceptTemplate(),notifications.message({text:error}).appendToModal(modal)}).on("progress",function(totalPercent,percent){currentFile.find(".total").html(percent+"%"),currentFile.find(".progressBar div").css("width",percent+"%"),100===percent&&currentFile.find(".total").html("100%, обработка")}).on("start",function(){}),filesAjax.send(),filesAjax}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("ajaxFilesXHR",["supported","ajax","stackList"],function(_ref){var supported=_ref.supported,ajax=_ref.ajax,stackList=_ref.stackList;this.service=function(){function _class(options){_classCallCheck(this,_class),this.options=options,this.files=options.files,this.input=options.input,this.url=options.url,this.data=options.data,this.callbacks=options.callbacks,this.toProceed=options.files.length,this.inProgress=0,this.total=options.files.length,this.totalLoaded=0,this.totalSize=0,this.totalPercent=0,this.current=0,this.fileRequests=stackList();var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=options.files[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)file=_step.value,this.totalSize+=file.size}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return _createClass(_class,[{key:"send",value:function(file){var _this=this;$.extend(file,{id:Math.random(),name:this.getName(file.file),size:file.file.size,ajax:!1,percent:!1,loaded:0});var self=this,params=this.data||{},queryString=this.url+"?ajaxFile="+file.name+"&"+jQuery.param(params);if(this.extend=function(args){return jQuery.extend(args,{totalLoaded:self.totalLoaded,totalSize:self.totalSize,totalPercent:self.totalPercent,file:file,loaded:file.loaded,size:file.size,percent:file.percent,toProceed:self.toProceed,current:self.current,total:self.total})},supported.formData){var form=new FormData;form.append(file.inputName,file.file),file.ajax=ajax(queryString,form,{ajaxExtend:{processData:!1,contentType:!1,type:"POST",xhr:function(){try{var xhr=new XMLHttpRequest;return xhr.upload.onloadstart=function(){this.inProgress++,this.callbacks.fire("begin",this.extend({}))},xhr.upload.onprogress=function(event){this.totalLoaded+=event.loaded-file.loaded,this.totalPercent=(this.totalLoaded/this.totalSize*100).toFixed(0),this.onProgress(event,file)},xhr}catch(e){return}}.safe()}})}else file.ajax=ajax(queryString,file.file,{processData:!1,contentType:!1,type:"POST",beforeSend:sky.func(function(jqXHR){jqXHR.setRequestHeader("X-Requested-With","XMLHttpRequest"),jqXHR.setRequestHeader("X-File-Name",encodeURI(file.name)),jqXHR.setRequestHeader("Content-Type","multipart/form-data"),jqXHR.setRequestHeader("Content-Disposition",'attachment; filename="'+encodeURI(file.name)+'"'),jqXHR.setRequestHeader("Accept","text/html,application/xhtml+xml,application/xml;q=0.9")})});file.ajax.on({success:function(all){_this.callbacks.fire("success",_this.extend(all))},error:function(all){_this.callbacks.fire("error",_this.extend(all))},notSuccess:function(all){_this.callbacks.fire("notSuccess",_this.extend(all))},always:function(all){_this.inProgress--,_this.toProceed--,_this.callbacks.fire("always",_this.extend(all)),_this.fileRequests.delete(file)}}),this.fileRequests.add(file)}},{key:"onProgress",value:function(event,fileRequestData){var percent=(event.loaded/event.total*100).toFixed(0);fileRequestData.loaded=event.loaded,percent!==fileRequestData.percent&&event.lengthComputable&&(fileRequestData.percent=percent,this.callbacks.fire("progress",this.extend({})))}},{key:"abort",value:function(){this.fileRequests.each(function(request){request.ajax.stop()}),this.callbacks.fire("abort",this.extend({}))}}],[{key:"getName",value:function(file){return file.name.replace(/.*(\/|\\)/,"")}}]),_class}()}),sky.service("calendar",["templates"],function(_ref){var templates=_ref.templates,calendar={monthsNames:window.page.data.monthsNames||["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],renderDays:function(){var current=moment(this.date),weeks=[],currentWeek=!1;for(current.date(1);current.month()===this.date.month();)currentWeek&&1!==current.day()||(currentWeek={number:current.isoWeek(),days:[]},weeks.push(currentWeek)),currentWeek.days.push({date:current.clone(),dateStr:current.format("YYYY.MM.DD"),day:0===current.day()?6:current.day()-1}),current.add(1,"d");this.dates.html("").append(templates.render("calendar-dates",{weeks:weeks,dateStr:this.date.format("YYYY.MM.DD"),current:this.date,period:this.period,since:this.since,till:this.till})),this.setTime()},dayPick:function(dayDiv,notClose){dayDiv&&this.date.date(parseInt(dayDiv.html())),this.field.val(this.getInputValue()).trigger("change").trigger("keyup"),notClose||this.close()},getInputValue:function(){return this.useTime?this.date.format("DD.MM.YYYY HH:mm"):this.period&&this.since.isSame(this.till)?this.since.format("DD.MM.YYYY"):this.period?this.since.format("DD.MM.YYYY")+" - "+this.till.format("DD.MM.YYYY"):this.date.format("DD.MM.YYYY")},setDayPick:function(){this.pickedDateView.html(this.getInputValue())},position:function(field){this.holder.insertAfter(field.parent()).css({marginTop:0,marginLeft:0,position:"absolute"}).css({marginTop:field.offset().top-this.holder.offset().top+field.outerHeight()+1,marginLeft:field.offset().left-this.holder.offset().left+1})},setTime:function(){this.holder.find(".time .hour").val(this.date.format("HH")),this.holder.find(".time .minute").val(this.date.format("mm"))},periodChangeDay:function(){var reset=function(){calendar.since=calendar.date.clone(),calendar.till=calendar.date.clone(),calendar.lastModified="none"};this.date.isBefore(this.since)?"since"!==this.lastModified?(this.since=this.date.clone(),this.lastModified="since"):reset():this.date.isAfter(this.till)?"till"!==this.lastModified?(this.till=this.date.clone(),this.lastModified="till"):reset():this.date.isSame(this.till)||this.date.isSame(this.since)?reset():"since"===this.lastModified?(this.till=this.date.clone(),this.lastModified="till"):(this.since=this.date.clone(),this.lastModified="since"),calendar.markSelected()},markSelected:function(){this.dates.find(".day").removeClass("selected").removeClass("subSelected").each(function(){var element=$(this),date=calendar.date.clone().date(parseInt(element.html()));calendar.period?date.isAfter(calendar.since)&&date.isBefore(calendar.till)?element.addClass("subSelected"):(date.isSame(calendar.since)||date.isSame(calendar.till))&&element.addClass("selected"):date.format("DD.MM.YYYY")===calendar.date.format("DD.MM.YYYY")&&element.addClass("subSelected")})},changeDay:function(element){this.date.date(parseInt(element.html())),this.period?this.periodChangeDay():(calendar.markSelected(),"since"===this.field.attr("name")?this.date.hour(0).minute(0):this.date.format("DD-MM-YYYY")===moment().format("DD-MM-YYYY")?this.date.hour(moment().hour()).minute(moment().minute()):this.date.hour(23).minute(59),this.useTime?this.setTime():this.dayPick(element))},changeYear:function(year){this.date.year(year),this.yearView.html(year),this.renderDays()},changeMonth:function(month){this.date.month(month),this.monthView.html(this.monthsNames[this.date.month()]+" "+this.date.year()),this.changeYear(this.date.year())},getDatePeriod:function(dateString){var parts=dateString.split("-"),till=void 0,since=this.getDate(parts[0].trim());till=1<parts.length?this.getDate(parts[1].trim()):this.getDate(parts[0].trim()),this.since=since,this.till=till,this.date=since.clone()},getDate:function(dateString){var date=!1;return dateString.match(/^\d{4}-\d{2}-\d{2} \d{1,2}:\d{1,2}$/)&&(date=moment(dateString,"YYYY-MM-DD HH:mm")),dateString.match(/^\d{4}-\d{2}-\d{2}$/)&&(date=moment(dateString,"YYYY-MM-DD")),dateString.match(/^\d{2}.\d{2}.\d{4}$/)&&(date=moment(dateString,"DD.MM.YYYY")),dateString.match(/^\d{2}.\d{2}.\d{4} \d{2}:\d{2}$/)&&(date=moment(dateString,"DD.MM.YYYY HH:mm")),date||(date=moment(),"since"===this.field.attr("name")&&date.hour(0).minute(0)),this.useTime||date.hour(0).minute(0),this.date=date},close:function(){this.holder&&this.holder.remove(),this.field&&(this.field.off("keyup.calendar"),this.field=!1)}},show=function(field,showTime){this.close(),this.field=field,this.period=!1,this.useTime=showTime||!1,this.lastPicked="none",field.is("input.datePeriod")?(this.period=!0,this.getDatePeriod(field.val())):this.getDate(field.val()),this.holder=templates.render("calendar",this),this.holder.action("click",".month .next",function(event){event.preventDefault(),calendar.changeMonth(calendar.date.month()+1)}).action("click",".month .prev",function(event){event.preventDefault(),calendar.changeMonth(calendar.date.month()-1)}).action("click",".year .next",function(event){event.preventDefault(),calendar.changeYear(calendar.date.year()+1)}).action("click",".year .prev",function(event){event.preventDefault(),calendar.changeYear(calendar.date.year()-1)}).action("click",".setNow",function(event){event.preventDefault(),calendar.date=moment(),calendar.renderDays(),calendar.setTime()}).action("click",".setToday",function(event){event.preventDefault(),calendar.date=moment(),calendar.date.hour(0),calendar.date.minute(0),calendar.renderDays(),calendar.setTime()}).action("click",".setWeek",function(event){event.preventDefault(),calendar.date=moment(),calendar.date.subtract(7,"d"),calendar.renderDays(),calendar.setTime()}).action("click",".dates .day",function(event){event.preventDefault(),$(this).is(".selected")&&!calendar.period?calendar.dayPick($(this)):(calendar.changeDay($(this)),calendar.dayPick(!1,!0))}).action("click",".apply",function(event){event.preventDefault(),calendar.dayPick()}).action("click",".time a",function(event){event.preventDefault(),calendar.date.hour(moment().hour()),calendar.date.minute(moment().minute()),calendar.setTime()}).action("keyup",".time .hour",function(){calendar.date.hour(this.value)}).action("keyup",".time .minute",function(){calendar.date.minute(this.value)}),this.dates=this.holder.find(".dates"),this.yearView=this.holder.find(".year .value"),this.monthView=this.holder.find(".month .value"),this.pickedDateView=this.holder.find(".pickedDate"),this.renderDays(),this.position(field),this.setDayPick(),this.field.on("keyup.calendar",function(){show(field,showTime)});var dateOriginal=void 0;this.dates.on("touchstart",function(event){var element=$(event.target);element.is(".day")&&(dateOriginal=calendar.date.clone().date(parseInt(element.html())))}).on("touchmove",function(event){event.preventDefault();var element=document.elementFromPoint(event.clientX||event.originalEvent.touches[0].clientX,event.clientY||event.originalEvent.touches[0].clientY);if((element=$(element)).is(".day")){var date=dateOriginal.clone().date(parseInt(element.html()));date.isBefore(dateOriginal)?(calendar.since=date.clone(),calendar.till=dateOriginal.clone()):(calendar.since=dateOriginal.clone(),calendar.till=date.clone()),calendar.lastModified="none",calendar.markSelected()}})}.bind(calendar);this.service=show}),sky.onReady(function(_ref2){var calendar=_ref2.calendar;$(document).action("click.calendar",function(event){var element=$(event.target||event.srcElement);element.is(".calendar")||element.parents(".calendar").length||$(".calendar").remove(),element.is("input.date")&&calendar(element),element.is("input.datePeriod")&&calendar(element,!1,!0),element.is("input.datetime")&&calendar(element,!0),element.is("input.datehour")&&calendar(element,!0)}).action("keydown.calendar",function(event){if(13===event.keyCode){var calendars=$(".calendar");calendars.length&&(calendars.find(".day.selected").trigger("click"),event.preventDefault())}})}),sky.service("callback",function(){var Callback=function Callback(flags){return this instanceof Callback?(this.functions=[],this.toRun=0,this.context=this):new Callback(flags)};Callback.prototype={add:function(func,context,options){return this.functions.push({func:func,context:context||!1,once:options&&options.once}),this},removeByContext:function(context){var i=void 0;for(i in this.functions)this.functions[i].context===context&&this.functions.splice(i,1);return this},removeByCallback:function(func){var i=void 0;for(i in this.functions)this.functions[i].func===func&&this.functions.splice(i,1);return this},fire:function(context,args){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this.functions[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var func=_step.value;func.func.apply(func.context||context,args)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},fireNext:function(args,context){if(this.functions.length<=this.toRun)return!1;this.toRun++;var result,current=this.functions[this.toRun-1],func=current.func;return context=current.context||context||window,"string"==typeof func&&(func=context[func]),!func||(result=!1!==func.apply(current.context||context,args),current.once&&(this.functions.splice(this.toRun-2,1),this.toRun--),result)}},this.service=Callback}),sky.service("callbacks",["callback"],function(_ref){var callback=_ref.callback,Callbacks=function Callbacks(flags){return this instanceof Callbacks?($.extend(!0,this,Callbacks.extend),this.advancedCallbacks={},this.flags(flags)):new Callbacks(flags)};Callbacks.prototype={flags:function(_flags){return this.callbacksFlags=_flags,this},removeListener:function(name,listener){this.advancedCallbacks[name]&&this.advancedCallbacks[name].removeByContext(listener)},on:function(name,func,context,options){var _this=this;return name instanceof Object?$.each(name,function(event,func){_this.on(event,func)}):$.each(this.getEventsNames(name),function(_,name){_this.advancedCallbacks[name]||(_this.advancedCallbacks[name]=callback(_this.callbacksFlags)),_this.advancedCallbacks[name].add(func,context||self.context,options||{})}),this},fire:function(name,args,options){var events=this.getEventsNames(name),self=this;(options=options||{}).noGlobal&&(events=events.slice(1)),$.each(events,function(_,event){if(self.advancedCallbacks[event]){for(;self.advancedCallbacks[event].fireNext(jQuery.extend({event:event},args||[]),self.context,options.possible););options.once||(self.advancedCallbacks[event].toRun=0)}})},getEventsNames:function(name){var names=name.split(","),events=[];return $.each(names,function(i,name){var elements=(name=name.replace(" ","")).split(".");events.push(elements[0]);for(var j=1;j<elements.length;j++)events.push(elements[0]+"."+elements[j]);2<elements.length&&events.push(elements.join("."))}),events},off:function(name){var func=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;func&&this.advancedCallbacks[name]?this.advancedCallbacks[name].removeByCallback(func):delete this.advancedCallbacks[name]}},this.service=Callbacks});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("dataOperator",["inputsIO","notifications","templates","utils","ajax","actions"],function(_ref){var inputsIO=_ref.inputsIO,notifications=_ref.notifications,templates=_ref.templates,utils=_ref.utils,ajax=_ref.ajax,searchField=(_ref.actions,function(){function searchField(name,virtual){_classCallCheck(this,searchField),this.name=name,this.inputName=name,this.virtual=virtual||!1,this.default=null,this.input=!1,this.value=null}return _createClass(searchField,[{key:"valueOrNullOnDefault",value:function(){return this.default instanceof Array&&this.value instanceof Array?utils.isObjectsEqual(this.value,this.default)?null:this.value:this.value===this.default?null:this.value}},{key:"read",value:function(){return"search"===this.virtual?this.searchRead():this.virtual?this.hashRead():(this.input&&(this.value=inputsIO.readInputsValues(this.input)),this.value)}},{key:"write",value:function(){return this.input&&inputsIO.writeInputsValue(null===this.value?this.default:this.value,this.input),this.value}},{key:"hashRead",value:function(){var hashValue=page.history.hashObject[this.name];return this.value=void 0===hashValue?this.default:hashValue}},{key:"searchRead",value:function(){var searchValue=page.history.searchObject[this.name];return this.value=void 0===searchValue?this.default:searchValue}}]),searchField}()),baseOptions={fields:{},historyType:"hash"},DataOperator=function(){function DataOperator(options){_classCallCheck(this,DataOperator),this.lastRequestData=!1,this.beforeRequest=!1,this.fields={},this.options=$.extend({},baseOptions,!0),this.setOptions(options)}return _createClass(DataOperator,[{key:"setOptions",value:function(options){return options.form&&$(options.form).action("submit",this.onFormSubmit.bind(this)),$.extend(this.options,options,!0),this}},{key:"onFormSubmit",value:function(event){if(event.preventDefault(),$(this.options.form).validForm()){var options={force:!0};this.fields.page&&(options["search"===this.options.historyType?"search":"hash"]={page:1}),this.reload(options)}}},{key:"prepareRequest",value:function(options){if((options=options||{}).hash&&page.history.set(options.hash),options.search&&page.history.search(options.search),options.virtual&&("search"===this.options.historyType?page.history.search(options.virtual):page.history.set(options.virtual)),options.fromUrl&&("search"===this.options.historyType?this.readSearch().writeForm():this.readHash().writeForm()),this.options.form&&!$(this.options.form).validForm())return!1;var data=this.read();return this.options.requestData&&(data=$.extend(data,this.options.requestData)),!(!1!==this.lastRequestData&&utils.isObjectsEqual(this.lastRequestData,data)&&!options.force)&&(options.fromUrl||"search"!==this.options.historyType?options.fromUrl||this.writeHash():this.writeSearch(),(!this.beforeRequest||!1!==this.beforeRequest(data,options))&&data)}},{key:"reload",value:function(options){var data=this.prepareRequest(options);return data&&this.request(data),this}},{key:"request",value:function(data){var self=this;self.lastRequestData=data,this.ajax&&this.ajax.stop(),this.ajax=ajax(this.options.url,data).on("success",function(response){self.lastResponse=response,self.render(response,data)}).on("error",function(error){self.error(error)}).on("always",function(){self.ajax=!1}),notifications.loading(this.ajax).reloadContent(this.options.holder)}},{key:"render",value:function(data,request){}},{key:"error",value:function(_error){}},{key:"fieldsList",value:function(list,virtual){var self=this;return $.each(list,function(_,item){self.options.fields[item]=virtual}),this}},{key:"realFieldsList",value:function(list){return this.fieldsList(list)}},{key:"virtualFieldsList",value:function(list){return this.fieldsList(list,!0)}},{key:"readReal",value:function(){var data={};return $.each(this.fields,function(i,field){if(!field.virtual){field.read();var val=field.valueOrNullOnDefault();null!==val&&(data[field.name]=val)}}),data}},{key:"read",value:function(){var data={};return $.each(this.fields,function(i,field){field.read();var val=field.valueOrNullOnDefault();null!==val&&(data[field.name]=val)}),data}},{key:"writeForm",value:function(){return $.each(this.fields,function(i,field){field.write()}),this}},{key:"readHash",value:function(){return $.each(this.fields,function(i,field){field.hashRead()}),this}},{key:"readSearch",value:function(){return $.each(this.fields,function(i,field){field.searchRead()}),this}},{key:"writeHash",value:function(){var write={};return $.each(this.fields,function(i,field){write[field.name]=field.valueOrNullOnDefault()}),page.history.set(write),this}},{key:"writeSearch",value:function(){var write={};return $.each(this.fields,function(i,field){write[field.name]=field.valueOrNullOnDefault()}),page.history.search(write),this}},{key:"initInputs",value:function(){var self=this;return $.each(this.options.fields,function(fieldName,virtual){var field=new searchField(fieldName,!!virtual&&self.options.historyType);if(field.virtual)"search"===self.options.historyType&&(field.virtual="search"),self.fields[fieldName]=field;else{if("*"===field.name[0]?(field.name=field.name.substring(1),field.input=$(self.options.form).find(".selectReplaceChoose[data-input="+field.name+"]")):field.input=$(self.options.form).find('[name="'+field.name+'"]'),!field.input||!field.input.length)return void delete self.fields[fieldName];(self.fields[fieldName]=field).default=field.read(),field.value=null}}),this}}]),DataOperator}();this.service={initOperator:function(options){return new DataOperator(options)},searchField:searchField,initLoader:function(loader,notifications,pagination,_ref2){var _ref2$reload=_ref2.reload,reload=void 0===_ref2$reload||_ref2$reload,_ref2$history=_ref2.history,history=void 0===_ref2$history||_ref2$history;loader.beforeRequest=function(data,options){this.lastRequestData&&!options.force||(data.count=!0)},loader.render=function(response){if($(this.options.holder).html("").append(templates.render("page-result-render",response)),this.pagination&&(this.pagination=this.pagination.remove()),void 0!==response.pages){var holder=$("#pages").html("");1<response.pages&&pagination&&(this.pagination=pagination.add({pages:response.pages,current:response.page,holder:holder}),this.pagination.onPageChange=function(pageNum){loader.reload({virtual:{page:pageNum}})})}},loader.error=function(error){this.pagination&&(this.pagination=this.pagination.remove()),$(this.options.holder).html("").append(notifications.message({text:error}).render)},reload&&loader.reload({fromUrl:!0}),history&&page.history.on("change",function(searchChanged,hashChanged){(searchChanged||hashChanged)&&loader.reload({fromUrl:!0})})}}}),sky.service("inputsIO",function(){this.service={readInputValue:function(input){if(input.is(".selectReplaceChoose")){var inputs=input.find("input"),data=this.readInputsValues(inputs);return data.length===inputs.length||data}return input.is(":checkbox")||input.is(":radio")?!!input.is(":checked")&&input.val():""!==input.val()&&input.val()},readInputsValues:function(inputs){if(1===inputs.length)return this.readInputValue(inputs);var valuesNamed=[],valuesLined=[],self=this;return inputs.each(function(){var input=$(this),value=self.readInputValue(input);!1!==value&&(valuesNamed.push({name:input.attr("name"),value:value}),valuesLined.push(value))}),1===valuesLined.length?valuesLined[0]:!!valuesLined.length&&valuesLined},writeInputValue:function(value,input){if(!input.is(".selectReplaceChoose"))return input.is(":checkbox")||input.is(":radio")?input.prop("checked",!1!==value):input.val(!1===value?"":value);var inputs=input.find("input");!0===value?inputs.prop("checked",!0):this.writeInputsValue(value,inputs),inputs.length&&inputs.first().trigger("change",{notByUser:!0})},writeInputsValue:function(values,inputs){if(inputs.length<2)return this.writeInputValue(values,inputs);inputs.is(":checkbox")||inputs.is(":radio")?(inputs.prop("checked",!1),values instanceof Array?($.each(values,function(_,val){inputs.filter('[value="'+val+'"]').prop("checked",!0)}),inputs.first().trigger("change",{notByUser:!0})):!1===values||!0===values?inputs.prop("checked",values).first().trigger("change",{notByUser:!0}):inputs.filter('[value="'+values+'"]').prop("checked",!0).trigger("change",{notByUser:!0})):inputs.val(values)}}}),sky.service("directives",["exceptions"],function(_ref){var exceptions=_ref.exceptions,list={},directives=this.service={add:function(name,options,directive){return directive||"function"!=typeof options||(directive=options,options={}),options.directive=directive,options.selector=name,list[name]=options,this},getAttributes:function(element){var attributes={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=element.get(0).attributes[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var attr=_step.value;attributes[attr.nodeName]=attr.nodeValue}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return attributes},parseElement:function(element,options){element=$(element);var attributes=this.getAttributes(element);if(options.json||options.jsonToData){var jsonScript=element.children('script[type="application/json"]');if(jsonScript.length)try{var json=JSON.parse(jsonScript.text());$.extend(attributes,json),options.jsonToData&&element.data("json",json)}catch(e){throw new exceptions.system.Error("Element "+options.selector+" should have json stored content, but error on parse appears")}}"function"==typeof options.directive&&options.directive(element,attributes)},parse:function(element){$.each(list,function(tag,options){$(tag,element).each(function(){directives.parseElement(this,options)}),element.is(tag)&&directives.parseElement(element,options)})}};jQuery.fn.parseDirectives=function(){return directives.parse(this),this},sky.onReady(function(){$("body").parseDirectives()})}),sky.service("drag",["callbacks"],function(_ref){_ref.callbacks;var self={bindEvents:function(event,events){self.bind(event).on("start",events.start).on("move",events.move).on("stop",events.stop)},bind:function(event){event=event.originalEvent||event;var started=!1,callbacks=callbacks();return event.button&&1!==event.button||(event.preventDefault(),$(document).on("mousemove.drag",function(event){return started?callbacks.fire("move",{event:event,x:event.pageX,y:event.pageY}):(started=!0,callbacks.fire("start",{event:event,x:event.pageX,y:event.pageY})),event.preventDefault(),!1}).on("mouseup.drag",function(event){$(document).off("mousemove.drag").off("mouseup.drag"),started&&(event.preventDefault(),callbacks.fire("stop",{event:event,x:event.pageX,y:event.pageY}))})),callbacks}};return self}),sky.service("history",["callbacks","supported"],function(_ref){var callbacks=_ref.callbacks;_ref.supported;sky.History=function(options){return this instanceof sky.History?(this.options=options||{},this.events=this.options.events||new callbacks,this.options.events=this.events,this):new sky.History(options)},$.extend(sky.History.prototype,{hashString:"",searchString:"",pathString:"",hashObject:{},searchObject:{},events:void 0,intervalId:0,base:"",navigate:function(path){path=path.replace("~",this.base),(window.location.pathname+window.location.search).substr(this.base.length)!==path&&(history.pushState({oldPath:this.pathString,newPath:path,search:this.searchObject},path,path),this.pathString=window.location.pathname.substr(this.base.length),this.searchString=this.getWindowSearch(),this.events.fire("navigate.path, always",{hash:this.hashObject,path:this.pathString,search:this.searchObject}))},change:function(){var hashDifference={},searchDifference={},old=this.pathString,hashChanged=!1,searchChanged=!1;this.supported&&(this.pathString=window.location.pathname.substr(this.base.length)),this.hashString!==this.getWindowHash()&&(hashDifference=this.getDifference(this.getWindowHash(),this.hashObject),hashChanged=!0),this.searchString!==this.getWindowSearch()&&(searchDifference=this.getDifference(this.getWindowSearch(),this.searchObject),searchChanged=!0),(this.pathString!==old||hashChanged||searchChanged)&&(this.rebuild(),this.events.fire("change, always",{hash:this.hashObject,hashDifference:hashDifference,searchDifference:searchDifference,path:this.pathString,oldPath:old,searchChanged:searchChanged,hashChanged:hashChanged,pathChanged:old!==this.pathString}))},setHash:function(path){""===path&&""!==window.location.hash&&(path="none"),this.hashString=path,window.location.hash=encodeURI(path)},setSearch:function(path){this.navigate(window.location.pathname+encodeURI(""!==path?"?"+path:""))},set:function(elements,force){var _this=this,changed=!1;force&&(this.hashObject=elements),$.each(elements,function(key,value){null===value?delete _this.hashObject[key]:_this.hashObject[key]=value,changed=!0}),(changed||force)&&this.setHash(decodeURIComponent(jQuery.param(this.hashObject).replace(/\+/g," "))),this.events.fire("set, always",{elements:elements,hash:this.hashObject,path:this.pathString})},search:function(elements,force){var changed=!1;force&&(this.searchObject=elements),$.each(elements,$.proxy(function(key,value){null===value?delete this.searchObject[key]:this.searchObject[key]=value,changed=!0},this)),(changed||force)&&this.setSearch(decodeURIComponent(jQuery.param(this.searchObject).replace(/\+/g," "))),this.events.fire("set, always",{elements:elements,hash:this.hashObject,path:this.pathString})},stringFromObject:function(obj){return jQuery.param(obj).replace(/\+/g," ")},getObjects:function(paramsString){var objects={};"#"!==paramsString.substr(0,1)&&"?"!==paramsString.substr(0,1)||(paramsString=paramsString.slice(1,paramsString.length));var subStrings=paramsString.split("&");return $.each(subStrings,function(i,str){var keyAndValue=str.split("=",2);if(!(keyAndValue.length<2)){var name=keyAndValue[0];"[]"===name.substr(-2)&&(name=name.substr(0,name.length-2)),keyAndValue[1]=str.substr(keyAndValue[0].length+1),void 0===objects[name]?objects[name]=keyAndValue[1]:(objects[name]instanceof Array||(objects[name]=[objects[name]]),objects[name].push(keyAndValue[1]))}}),objects},getDifference:function(string,stored){return function getObjectsDifference(first,second){var difference={},localDiff=!1;if(!(first instanceof Array&&second instanceof Array||first instanceof Object&&second instanceof Object))return first!==second&&second;if($.each(first,function(key,value){void 0===second[key]?difference[key]=null:(localDiff=getObjectsDifference(value,second[key]))&&(difference[key]=localDiff)}),$.each(second,function(key,value){void 0===first[key]&&(difference[key]=value)}),first instanceof Array){var returnArray=[];$.each(difference,function(key){returnArray.push(difference[key])}),difference=returnArray}return 0!==difference.length&&difference}(stored,this.getObjects(decodeURI(string)))},rebuild:function(){return this.hashString=this.getWindowHash(),this.hashObject=this.getObjects(this.hashString),this.searchString=this.getWindowSearch(),this.searchObject=this.getObjects(this.searchString),this.pathString=window.location.pathname,this},getWindowHash:function(){var hash=decodeURI(window.location.hash);return"#"===hash.substr(0,1)&&(hash=hash.slice(1)),hash},getWindowSearch:function(){var search=decodeURI(window.location.search);return"?"===search.substr(0,1)&&(search=search.slice(1)),search},start:function(){return this.options.base&&(this.base=this.options.base),window.history&&(window.onpopstate=this.change.bind(this)),this.intervalId||(this.intervalId=setInterval(this.change.bind(this),this.options.time||500)),this.change(),this}})});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("localStorage",["callbacks"],function(_ref){var callbacks=_ref.callbacks;this.service=function(){function _class(options){_classCallCheck(this,_class),this.name=options.name||"global",this.events=callbacks()}return _createClass(_class,[{key:"load",value:function(id){var items=this.getItems();return items?items[id]:void 0}},{key:"getItems",value:function(){try{var items=localStorage.getItem(this.name);if(null!==items)return $.parseJSON(items)}catch(e){this.events.fire("error",{storage:this})}}},{key:"save",value:function(id,data){try{var items=this.getItems();items[id]=data,localStorage.setItem(this.name,JSON.stringify(items))}catch(e){this.events.fire("error",{storage:this})}return this}},{key:"remove",value:function(id){try{var items=this.getItems();delete items[id],localStorage.setItem(this.name,JSON.stringify(items))}catch(e){this.events.fire("error",{storage:this})}return this}}]),_class}()});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("model",["modelsStorage","callbacks"],function(_ref){var modelsStorage=_ref.modelsStorage,callbacks=_ref.callbacks,modelsDefinition={},BaseDefinition=(function(){function Model(type,data){_classCallCheck(this,Model),this.definition=BaseDefinition,modelsDefinition[type]&&(this.definition=modelsDefinition[type]),this.id=data[this.definition.id]||null,this.type=type,this.data={},this.callbacks=callbacks(),this.definition.creation.bind(this)($.extend({},data,!0))}_createClass(Model,[{key:"extend",value:function(data){return this.definition.extension.bind(this)($.extend({},data,!0)),this.changed()}},{key:"changed",value:function(){return this.callbacks.fire("change",{model:this}),this}},{key:"removeFromStorage",value:function(){modelsStorage.remove(this)}},{key:"addListener",value:function(func){this.callbacks.on("change",func)}},{key:"removeListener",value:function(func){this.callbacks.off("change",func)}}])}(),{id:"id",creation:function(data){this.data=data},extension:function(data){$.extend(!0,this.data,data)}});this.service={addDefinition:function(name,definition){modelsDefinition[name]=$.extend({},BaseDefinition,definition)},fromData:function(type,data){var model=new this.Model(type,data),cached=modelsStorage.add(model);return cached?cached.extend(data):model}}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("modelsManager",["callbacks","model"],function(_ref){var callbacks=_ref.callbacks,model=_ref.model,Manager=function(){function Manager(type,arr){var _this=this;_classCallCheck(this,Manager),this.items=[],this.type=type,this.callbacks=callbacks(),$.each(arr,function(_,model){_this.items.push(model)})}return _createClass(Manager,[{key:"reloadFromArray",value:function(arr){var _this2=this;this.items=[],$.each(arr,function(_,data){_this2.items.push(model.fromData(_this2.type,data))})}},{key:"count",value:function(){return this.items.length}},{key:"addListener",value:function(func){this.callbacks.on("change",func)}},{key:"removeListener",value:function(func){this.callbacks.off("change",func)}}]),Manager}();this.service={fromArray:function(type,arr){var items=[];return $.each(arr,function(_,data){items.push(sky.model.fromData(type,data))}),new Manager(type,items)}}}),sky.service("modelsStorage",function(){var cache={};this.service={add:function(model){var cached=this.search(model.type,model.id);if(cached)return cached;this.cache[model.type]||(this.cache[model.type]={}),this.cache[model.type][model.id]=model},search:function(type,id){return!(!cache[type]||!cache[type][id])&&cache[type][id]},remove:function(model){delete cache[model.type][model.id]}}}),sky.service("notifications",["stackList","callbacks","visibleCalculator","templates","windows","tips"],function(_ref){var stackList=_ref.stackList,callbacks=_ref.callbacks,visibleCalculator=_ref.visibleCalculator,templates=_ref.templates,windows=_ref.windows,tips=_ref.tips,message=function message(options){if(!(this instanceof message))return new message(options);this.render=templates.render("forms-message",options)};message.prototype={modal:function(){return windows.Modal(this.render)},appendToModal:function(modal){modal.holder.append(this.render)},tip:function(object,align){tips.Tip(object,{create:this.render,close:5}).show(align||"top")}};var loadings=stackList(),loading=function loading(ajax){var _this=this,global=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(!(this instanceof loading))return new loading(ajax,global);this.global=global,this.render=$("<div><div></div></div>").addClass("ajaxLoading"),this.global&&this.render.addClass("fixed").appendTo("body"),ajax&&($("<span/>").appendTo(this.render.addClass("cancelable")).click(function(){ajax.stop()}),ajax.on("always",function(){_this.hide()})),this.callbacks=callbacks(),loadings.add(this)};return loading.prototype={inModalWindow:function(modal){var content=modal.holder.children().hide();this.render.appendTo(modal.holder),this.callbacks.on("hide",function(){return content.show()})},reloadContent:function(contentHolder){var _this2=this;if(this.holder.length){this.holder=contentHolder=$(contentHolder).addClass("withLoading");var content=contentHolder.children();return this.global?(content.disable(),this.calc=visibleCalculator(contentHolder,this.render.outerHeight(),"body"),this.setPosition=function(){var position=this.calc.calculate();this.render.css({left:position.left+position.width/2,top:position.top+position.height/2})},this.setPosition(),this.callbacks.on("hide",function(){content.enable(),$(window).off("scroll.notification")}),$(window).on("scroll.notification",function(){_this2.setPosition()})):(content.hide(),this.render.appendTo(this.holder),this.callbacks.on("hide",function(){content.show()})),this}},setHolder:function(holder){return this.holder=$(holder).addClass("withLoading").append(this.render),this},hide:function(){this.holder&&this.holder.removeClass("withLoading"),this.render.remove(),this.callbacks.fire("hide"),loadings.remove(this)}},{loading:loading,message:message,reCalculate:function(){loadings.each(function(instance){instance.calc.init(),instance.setPosition()})}}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.services.add("pagination",["templates","stackList"],function(_ref){var templates=_ref.templates,list=(0,_ref.stackList)(),Pagination=function(){function Pagination(_ref2){var pages=_ref2.pages,holder=_ref2.holder,_ref2$current=_ref2.current,current=void 0===_ref2$current?1:_ref2$current;return _classCallCheck(this,Pagination),this instanceof Pagination?(list.add(this),this.pages=pages,this.current=current,this.pageWidth=50,this.id=last,this.pages<2||(this.dimensions={startPage:1,lastStartPage:0,pagesVisible:0,pagesInvisible:0,scrollAvailable:0,scrollStart:0,tumbler:10},this.dom={},this.dom.holder=templates.render("pagination",{}).data("pagination",this),this.dom.slider=this.dom.holder.find(".pages"),this.dom.pages=this.dom.slider.children(),this.dom.back=this.dom.holder.children(".left"),this.dom.forward=this.dom.holder.children(".right"),holder&&this.dom.holder.appendTo(holder),9999<this.pages?(this.dom.slider.addClass("tenthousand"),this.pageWidth=80):999<this.pages?(this.dom.slider.addClass("thousand"),this.pageWidth=70):99<this.pages&&(this.dom.slider.addClass("hundred"),this.pageWidth=60),this.redraw(),this.goToPage(this.current)),this):new Pagination({pages:pages,holder:holder,current:current})}return _createClass(Pagination,[{key:"onPageChange",value:function(newPage){}},{key:"remove",value:function(){this.dom.holder.remove(),list.remove(this)}},{key:"redraw",value:function(){if(this.dom.holder.is(":visible")){this.dom.slider.css("width","auto"),this.dimensions.pagesVisible=Math.floor((this.dom.holder.innerWidth()-100)/this.pageWidth),this.dimensions.pagesInvisible=0<this.pages-this.dimensions.pagesVisible?this.pages-this.dimensions.pagesVisible:0,this.dimensions.lastStartPage=this.dimensions.pagesInvisible+1;var toShow=this.dimensions.pagesVisible>this.pages?this.pages:this.dimensions.pagesVisible;this.dom.slider.css("width",toShow*this.pageWidth),this.drawPages(this.dimensions.startPage),this.createScroll(),this.dom.scrollLine&&this.dom.runner.css("left",this.calculate().scroll)}}},{key:"createScroll",value:function(){this.pages<=this.dimensions.pagesVisible?this.dom.scrollLine&&(this.dom.scrollLine.remove(),this.dom.scrollLine=!1):(this.dom.scrollLine||(this.dom.scrollLine=templates.render("pagination-scroll",{}).appendTo(this.dom.slider),this.dom.runner=this.dom.scrollLine.children()),this.dimensions.scrollStart=this.dom.scrollLine.position().left+2,this.dimensions.scrollAvailable=this.dom.scrollLine.outerWidth()-this.dom.scrollLine.children().outerWidth()-4)}},{key:"calculate",value:function(position){return void 0===position&&(position=this.dom.runner.offset().left-this.dimensions.scrollStart),position=0<(position-=this.dimensions.scrollStart)?position:0,{pages:Math.floor(this.dimensions.pagesInvisible*(position/this.dimensions.scrollAvailable))+1,scroll:Math.floor(this.dimensions.scrollAvailable*(this.dimensions.startPage-1)/this.dimensions.pagesInvisible+this.dimensions.scrollStart)}}},{key:"drawPages",value:function(start){this.dom.pages.html(""),start>this.dimensions.pagesInvisible&&(start=this.dimensions.pagesInvisible+1),start<1&&(start=1);for(var i=start;i<=this.pages&&i<start+this.dimensions.pagesVisible;)templates.render("pagination-page",{page:i,current:this.current}).appendTo(this.dom.pages),i++;this.dimensions.startPage=start}},{key:"goToPage",value:function(page){return this.pages<2||((page=parseInt(page))<1?page=1:page>this.pages&&(page=this.pages),this.dimensions.startPage<=page&&page<this.dimensions.startPage+this.dimensions.pagesVisible||(this.drawPages(page),this.dom.scrollLine&&this.dom.runner.css("left",this.calculate().scroll)),this.dom.pages.children().removeClass("active").filter("[page="+page+"]").addClass("active"),1<page?this.dom.back.enable():this.dom.back.disable(),page===this.pages?this.dom.forward.disable():this.dom.forward.enable(),this.current!==page&&this.onPageChange(page),this.current=page),this}},{key:"scroll",value:function(event){var pos=event.pageX-10;this.dimensions.scrollStart>pos&&(pos=this.dimensions.scrollStart),this.dimensions.scrollStart+this.dimensions.scrollAvailable<pos&&(pos=this.dimensions.scrollStart+this.dimensions.scrollAvailable),this.dom.runner.css({left:pos}),this.drawPages(this.calculate(pos).pages)}}]),Pagination}();$(window).on("resize",function(){var _this=this;list.each(function(){_this.redraw()})}),this.service={add:function(options){return new Pagination(options)}}}),sky.service("stackList",function(){var List=this.service=function(){if(!(this instanceof List))return new List;var elements={},lastId=0,total=0;this.last=function(){var last=void 0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=elements[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){last=_step.value}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return last||!1},this.add=function(element){total++,element[++lastId]=element},this.remove=function(element){for(var index in elements)elements.hasOwnProperty(index)&&elements[index]===element&&(delete elements[index],total--)},this.total=function(){return total},this.elements=function(){return elements},this.each=function(callback){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=elements[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var single=_step2.value;callback.apply(single,single)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}}),sky.onReady(function(_ref){var suggester=_ref.suggester;$(document).on("click",function(event){var element=$(event.target||event.srcElement);element.is("[type=submit]")||element.closest(".suggester").length||element.data("suggester")||suggester.hide()})}),sky.service("suggester",["templates"],function(_ref2){var templates=_ref2.templates,render=void 0,object=void 0,lastList=void 0,suggester=this.service={hide:function(){render&&(render.remove(),render=!1),object&&(object.removeData("suggester"),object=!1),$(document).off("keyup.suggester, keydown.suggester")},show:function(input,list){suggester.hide(),lastList=list,render=templates.render("suggester",{items:list}).insertAfter(input.closest("label, .label")),object=input.data("suggester",render);var elementPosition=input.offset(),renderPosition=render.offset();render.css({"margin-left":elementPosition.left-renderPosition.left,"margin-top":elementPosition.top-renderPosition.top+input.outerHeight()});var children=render.children().on("click",function(){input.val($(this).html()),suggester.hide(),lastList[$(this).attr("data-index")].callback&&lastList[$(this).attr("data-index")].callback()});$(document).on("keyup.suggester",function(event){if(38===event.keyCode||40===event.keyCode){var selected=children.filter(".selected");children.removeClass("selected"),38===event.keyCode&&(selected.length&&selected.prev().length?selected.prev().addClass("selected"):children.last().addClass("selected")),40===event.keyCode&&(children.removeClass("selected"),selected.length&&selected.next().length?selected.next().addClass("selected"):children.first().addClass("selected"))}27===event.keyCode&&suggester.hide()}).on("keydown.suggester",function(event){if(13===event.keyCode){var selected=children.filter(".selected");selected.length?(selected.trigger("click"),event.preventDefault()):suggester.hide()}})}}}),sky.service("supported",function(){try{this.service.fullScreen=void 0!==document.webkitIsFullScreen,this.service.formData=window.FormData&&!0,this.service.XHRIsSupported=XHRIsSupported,this.service.XHRUpload=void 0!==(new XMLHttpRequest).upload,this.service.localStorage=!!window.localStorage}catch(e){}}),sky.service("templates",["localStorage","supported","directives","exceptions"],function(_ref){var localStorage=_ref.localStorage,supported=_ref.supported,directives=_ref.directives,exceptions=_ref.exceptions,templatesList={},templatesCompiled={},Templates=this.service={globals:{},storage:!!supported.localStorage&&localStorage({name:"jsTemplates"}),add:function(options){templatesList[options.name]=options.template,this.storage&&this.storage.save(options.name,options.template)},renderWithHolder:function(name,data,noDirectives){this.compile(name),data=$.extend(!0,{},data,{globals:this.globals});var temp=$("<div/>").append(templatesCompiled[name].render(data));return noDirectives||directives.parse(temp),temp},render:function(name,data,noDirectives){return this.renderWithHolder(name,data,noDirectives).children()},renderToText:function(name,data,noDirectives){return this.renderWithHolder(name,data,noDirectives).html()},renderByText:function(text,data,noDirectives){data=jQuery.extend(!0,data,{globals:this.globals});var temp=$("<div/>").append(twig({data:text}).render(data));return noDirectives||directives.parse(temp),temp.children()},renderByTextToText:function(text,data,noDirectives){return $("<div/>").append(this.renderByText(text,data,noDirectives)).html()},compile:function(name){if(!templatesCompiled[name]){this.load(name);var compiled=twig({id:name,data:templatesList[name]});if(!compiled)throw new exceptions.system.Error('Error during compiling template "'+name+'"');templatesCompiled[name]=compiled}},load:function(name){var fromLS=void 0;if(!templatesList[name]&&this.storage&&(fromLS=this.storage.load(name)))return templatesList[name]=fromLS;if(templatesList[name])return templatesList[name];if(!(templatesList[name]=$('script[type="text/template"][id='+name+"]").html()))throw new exceptions.system.Error("Can't find template – "+name);return this.storage&&this.storage.save(name,{template:templatesList[name]}),templatesList[name]}};$(document).onReady(sky.func(function(){$('script[type="text/template"]').each(function(){var self=$(this);Templates.add({name:self.attr("id"),template:self.html()})}),window.page.data.templates&&Templates.storage&&$.each(window.page.data.templates,function(){$.cookie("storedTemplates-"+this.path,this.date)})}))}),sky.service("tips",["stackList","callbacks"],function(_ref){var stackList=_ref.stackList,callbacks=_ref.callbacks,list=stackList(),tips=this.service={hideAll:function(withoutAutoHide){$.each(list.elements(),function(_,tip){(withoutAutoHide||tip.autoHide)&&this.hide()})},getLast:function(){list.last()},bind:function(selector,align,options){$(selector).on({mouseenter:function(){$(this).data("tip")||tips.Tip(this,options).show(align)},mouseleave:function(){var tip=$(this).data("tip");tip&&tip.hide(align)}})},Tip:function(object){var _this=this,_ref2=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},_ref2$autoHide=_ref2.autoHide,autoHide=void 0===_ref2$autoHide||_ref2$autoHide,_ref2$create=_ref2.create,create=void 0!==_ref2$create&&_ref2$create,_ref2$close=_ref2.close,close=void 0!==_ref2$close&&_ref2$close,_ref2$ajax=_ref2.ajax,ajax=void 0!==_ref2$ajax&&_ref2$ajax,_ref2$highlight=_ref2.highlight,highlight=void 0!==_ref2$highlight&&_ref2$highlight;return this instanceof tips.Tip?(("function"!=typeof create||(this.tip=create(object),this.tip))&&(this.object=$(object).data("tip",this),this.callbacks=callbacks(),this.autoHide=autoHide,"function"!=typeof create&&(this.tip=$("<div/>").addClass("tip").append('<div class="tipContent"></div>').insertBefore(object),!create&&this.object.attr("title")?create=this.object.attr("title"):create||(create="Пожалуйста подождите"),this.tip.find(".tipContent").append(create)),highlight&&(this.shadow=$("<div/>").css({opacity:0,position:"absolute",width:"100%",height:"100%",left:0,top:0,background:"rgba(0,0,0,0.5)"}).appendTo("body")),"number"==typeof close?this.closeTimeout=setTimeout(function(){return _this.hide()},close):close&&$("<div/>").addClass("close").appendTo(this.tip).on("click",function(){return _this.hide()}),ajax&&ajax.on("always",function(){return _this.hide()}),this.tip.css("display","none"),list.add(this)),this):new tips.Tip(object,{autoHide:autoHide,create:create,close:close,ajax:ajax,highlight:highlight})}};$.extend(tips.Tip.prototype,{show:function(align){var self=this,offset=this.tip.css({left:"",top:"",marginLeft:"",marginTop:"",display:""}).offset();switch(this.tip.stop(),align&&(this.align=align),this.shadow&&this.shadow.stop().show().animate({opacity:1},100),this.align){case"right":this.tip.addClass("right").css({marginLeft:this.object.offset().left+this.object.outerWidth()-offset.left,marginTop:this.object.offset().top-offset.top+parseInt((this.object.outerHeight()-this.tip.outerHeight())/2),opacity:0}),this.tip.animate({opacity:1,marginLeft:"+=10"},100);break;case"left":this.tip.addClass("left").css({marginLeft:this.object.offset().left-offset.left-this.tip.outerWidth(),marginTop:this.object.offset().top-offset.top+parseInt((this.object.outerHeight()-this.tip.outerHeight())/2),opacity:0}),this.tip.animate({opacity:1,marginLeft:"-=10"},300);break;case"top":var left=this.object.offset().left-offset.left;offset.left+left+this.tip.outerWidth()>$(window).outerWidth()&&(left=left-this.tip.outerWidth()+this.object.outerWidth()),this.tip.addClass("top").css({marginLeft:left,marginTop:this.object.offset().top-this.tip.outerHeight()-offset.top,opacity:0}),this.tip.animate({opacity:1,marginTop:"-=10"},300);break;case"bottom":var _left=this.object.offset().left-offset.left;offset.left+_left+this.tip.outerWidth()>$(window).outerWidth()&&(_left=_left-this.tip.outerWidth()+this.object.outerWidth()),this.tip.addClass("bottom").css({marginLeft:_left,marginTop:this.object.offset().top+this.object.outerHeight()-offset.top,opacity:0}),this.tip.animate({opacity:1,marginTop:"+=10"},300);break;case"instead":this.tip.css({width:this.object.outerWidth(),height:this.object.outerHeight(),display:"none"}),this.object.fadeOut(100,function(){self.tip.fadeIn(100)}).get(0).blur();break;case"inside":this.tip.css({width:this.object.outerWidth(),height:this.object.outerHeight(),display:"none"}),this.tip.css("opacity",0).animate({opacity:1},100)}return this.tip.css({left:"",top:""}),this},hide:function(){var _this2=this;this.closeTimeout&&clearTimeout(this.closeTimeout),this.tip.stop();var align=this.align,callback=function(){list.remove(_this2),_this2.object.removeData("tip"),_this2.tip.remove(),_this2.callbacks.fire("hide",_this2)};return align||callback(),this.shadow&&this.shadow.animate({opacity:0},100,function(){_this2.shadow.remove()}),"right"===align&&this.tip.animate({opacity:0,marginLeft:"+=10"},100,callback),"left"===align&&this.tip.animate({opacity:0,marginLeft:"-=10"},100,callback),"instead"===align&&this.tip.fadeOut({opacity:0},200,callback),"top"===align&&this.tip.animate({opacity:0,marginTop:"-=5"},200,callback),"bottom"===align&&this.tip.animate({opacity:0,marginTop:"+=5"},200,callback),"inside"===align&&this.tip.animate({opacity:0},200,callback),this},get:function(){return this.tip},set:function(text){return this.tip.children(".tipContent").html(text),this},add:function(what){return this.tip.children(".tipContent").append(what),this}})});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};sky.service("utils",function(){this.service={isObjectsEqual:function(first,second){if((void 0===first?"undefined":_typeof(first))!==(void 0===second?"undefined":_typeof(second)))return!1;if(first instanceof Array||first instanceof Object){var key=void 0;for(key in first)if(first.hasOwnProperty(key)){if(void 0===second[key])return!1;if(!this.isObjectsEqual(first[key],second[key]))return!1}for(key in second)if(second.hasOwnProperty(key)&&void 0===first[key])return!1}else if(first!==second)return!1;return!0},addLeadingZero:function(value){return(value=parseInt(value))<10&&(value="0"+value),value},encode:function(rawStr){return rawStr.replace(/[\u00A0-\u9999<>&]/gim,function(i){return"&#"+i.charCodeAt(0)+";"})},jsonData:function(data,inputName){return'<script type="application/json"'+(inputName?' input-name="'+inputName+'"':"")+">"+sky.encode(JSON.stringify(data))+"<\/script>"},prepareSelectData:function(items,func,_ref){var _ref$columnSplitOn=_ref.columnSplitOn,columnSplitOn=void 0===_ref$columnSplitOn?6:_ref$columnSplitOn,_ref$maxColumns=_ref.maxColumns,maxColumns=void 0===_ref$maxColumns?4:_ref$maxColumns,index=0,columns=[],columnsCount=items.length/columnSplitOn,groupHolder=void 0,compiled=void 0;columnsCount<1&&(columnsCount=1),maxColumns<columnsCount&&(columnsCount=maxColumns);var perColumn=Math.ceil(items.length/columnsCount),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=items[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){(compiled=func({item:_step.value,index:index,column:columns.length}))&&(index%perColumn==0&&(groupHolder=[],columns.push(groupHolder)),groupHolder.push(compiled),index++)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return 0===index?[]:{groups:columns}}}}),sky.onReady(function(_ref){var validator=_ref.validator;jQuery.fn.validForm=function(){return validator.validateForm(this)}.safe(),jQuery.fn.validationRule=function(name,options){return validator.addRule(this,name,options)}.safe(),$(document).on("change keyup","[data-validate]",function(){validator.validateElement($(this))})}),sky.service("validator",function(){var validator=this.service={validateForm:function(form){var pass=!0,self=this;return form.find("input, select, textarea, .selectReplace, [data-validate]").filter(":visible").each(function(){var element=$(this);self.shouldBeValidated(element)&&!self.validateElement(element,form)&&(pass=!1)}),pass},addRule:function(element,name,options){return this.Options(element).addRule(name,options||{}),this},validateElement:function(element,form){var self=this,options=this.Options(element),totalPass=!0,value=element.val(),firstError=!1,lastSuccess=!1,firstSuccess=!1;if(element.is(".selectReplace")){var inputs=element.next().find("input:checked");value=inputs.length?element.is(".single")?element.next().find("input:checked").val():element.next().find("input:checked").length?"true":"":""}return $.each(options.rules,function(name,ruleOverload){var compiledRule=jQuery.extend(!0,{},self.rules[name]||self.Rule({}),ruleOverload||{});"function"==typeof compiledRule.message&&(compiledRule.message=compiledRule.message.call(this)),self.validate(value,compiledRule,element,form)?(compiledRule.onSuccess(element,compiledRule),lastSuccess=compiledRule,firstSuccess||(firstSuccess=compiledRule)):(compiledRule.onError(element,compiledRule),compiledRule,firstError||(firstError=compiledRule),totalPass=!1)}),totalPass?options.onSuccess(element,lastSuccess):options.onError(element,firstError),totalPass},shouldBeValidated:function(element){return element.attr("data-validate")||element.data("validationOptions")},validate:function(value,compiledRule,element,form){return compiledRule.rule.call(compiledRule,value,element,form)}};validator.ruleDefaults={},validator.optionsDefaults={onSuccess:function(element){element.removeClass(this.errorClass),this.successClass&&element.addClass(this.successClass)},onError:function(element){element.addClass(this.errorClass),this.successClass&&element.removeClass(this.successClass)}},validator.Rule=function(overload){return this instanceof validator.Rule?(this.rule=function(){return!0},this.message="Это поле заполнено не верно",this.options=[],this.onSuccess=function(element){},this.onError=function(element){},jQuery.extend(this,overload),this):new validator.Rule(overload)},validator.rules={required:validator.Rule({rule:function(value){return!!value.length},message:"Это поле необходимо заполнить"}),requiredIfFilled:validator.Rule({rule:function(value){var item=$(this.options[0]);return item.is(":radio, :checkbox")?!item.is(":checked")||value:""===item.val()||value},message:"Это поле необходимо заполнить"}),date:validator.Rule({rule:function(value){return!value||value.match(/^\d{4}-\d{2}-\d{2}( \d{2}:\d{2}(:\d{2})?)?$/)||value.match(/^\d{2}.\d{2}.\d{4}( \d{2}:\d{2}(:\d{2})?)?$/)},message:"Дата указана неверно"}),period:validator.Rule({rule:function(value){return!value||value.match(/^\d{4}-\d{2}-\d{2}$/)||value.match(/^\d{2}.\d{2}.\d{4}$/)||value.match(/^\d{2}.\d{2}.\d{4}\s*-\s*\d{2}.\d{2}.\d{4}$/)||value.match(/^\d{4}-\d{2}-\d{2}\s*-\s*\d{4}-\d{2}-\d{2}$/)},message:"Период указан неверно"}),email:validator.Rule({rule:function(value){return value&&value.match(/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/)},message:"Почтовый адрес указан неверно"}),same:validator.Rule({rule:function(value){return value===$('[name="'+this.options[0]+'"]').val()},message:"Поля не совпадают"}),url:validator.Rule({rule:function(value){return""===value||value.match(/^(https?:\/\/.+)$/)},message:"Не корректный адрес URI"}),regexp:validator.Rule({rule:function(value){return""===value||value.match(new RegExp(this.options[0]))},message:"Введите корректное значение"}),numeric:validator.Rule({rule:function(value){return""===value||value.match(/^-?[0-9]+(\.[0-9]+)?$/)},message:"Введите число"}),positive:validator.Rule({rule:function(value){return""===value||value.match(/^[0-9]+(\.[0-9]+)?$/)&&0<parseFloat(value)},message:"Введите положительное число"}),max:validator.Rule({rule:function(value){return""===value||value.match(/^[0-9]+(\.[0-9]+)?$/)&&parseFloat(value)<=parseFloat(this.options[0]||0)},message:function(){return"Введите число, не обльше чем "+(this.options[0]||0)}}),min:validator.Rule({rule:function(value){return""===value||value.match(/^[0-9]+(\.[0-9]+)?$/)&&parseFloat(value)>=parseFloat(this.options[0]||0)},message:function(){return"Введите число, не меньше чем "+(this.options[0]||0)}}),minLength:validator.Rule({rule:function(value){return""===value||value.length>=(this.options[0]||0)},message:"В этом поле нехватает символов"}),maxLength:validator.Rule({rule:function(value){return""===value||value.length<=(this.options[0]||0)},message:"В этом поле слишком много символов"})},validator.Options=function(element){return this instanceof validator.Options?(this.onSuccess=function(){},this.onError=function(){},this.successClass=!1,this.errorClass="error",jQuery.extend(!0,this,validator.optionsDefaults),this.rules={},this.element=element,this.getDeclaredRules(),this.element.data("validationOptions",this),this):element.data("validationOptions")||new validator.Options(element)},validator.Options.prototype={getDeclaredRules:function getDeclaredRules(){var attr=this.element.attr("data-validate"),self=this;attr&&$.each(attr.split(";"),function(_,name){var params=name.match(/(\w+)\((.*)\)/);params&&(name=params[1],params=params[2].match(/(('[^']+')|([\d\w]+))/g),$.each(params,function(i,val){params[i]=eval(val.trim())})),self.addRule(name.trim(),{options:params||[]})})},addRule:function(name,options){return this.rules[name]=jQuery.extend({},validator.ruleDefaults,options),this.element.attr("data-validate")||this.element.attr("data-validate","true"),this}}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}sky.service("visibleCalculator",function(){var Calculator=this.service=function(){function _class(holder,minHeight,scrollable){if(_classCallCheck(this,_class),!(this instanceof Calculator))return new Calculator(holder,minHeight,scrollable);this.holder=$(holder),this.scrollable=scrollable,this.minHeight=minHeight,this.init()}return _createClass(_class,[{key:"init",value:function(){var offset=this.holder.offset();this.holderRect={left:offset.left,top:offset.top,width:this.holder.outerWidth(),height:this.holder.outerHeight()}}},{key:"calculate",value:function(){var scrollTop=$(this.scrollable).scrollTop(),windowHeight=$(window).height(),windowWidth=$(window).width(),sizes={left:this.holderRect.left,right:this.holderRect.left+this.holderRect.width,top:this.holderRect.top-scrollTop,width:this.holderRect.width,height:this.holderRect.height,realHeight:this.holderRect.height,scrollTop:scrollTop,scrollLeft:0,windowHeight:windowHeight,windowWidth:windowWidth};return sizes.height<this.minHeight&&(sizes.height=this.minHeight),sizes.bottom=sizes.top+sizes.height,sizes.top<0&&(sizes.bottom<this.minHeight?(sizes.bottom=sizes.bottom<0?0:sizes.bottom,sizes.top=sizes.bottom-this.minHeight,sizes.height=this.minHeight):(sizes.height=sizes.bottom,sizes.top=0)),windowHeight<sizes.bottom&&(windowHeight-sizes.top<this.minHeight?(sizes.height=this.minHeight,sizes.top=windowHeight-sizes.top<0?0:sizes.top,sizes.bottom=sizes.top+this.minHeight):(sizes.height=windowHeight-sizes.top,sizes.bottom=0)),sizes}},{key:"getDropOffset",value:function(replace,popup){if(popup.is(":visible")){popup.removeClass("hidden").css({left:0,top:0});var popupWidth=popup.outerWidth(),popupHeight=popup.outerHeight();popup.css({marginLeft:"",marginTop:"",width:"",left:"",top:""});var win=$(window),replaceOffset=replace.offset(),popupOffset=popup.offset(),leftDifference=popupOffset.left-replaceOffset.left,topDifference=popupOffset.top-replaceOffset.top,middle=!1,visible=this.calculate();visible.bottom+popupHeight>=visible.windowHeight?popup.css("marginTop",topDifference+visible.realHeight+1):visible.top>popupHeight?popup.css("marginTop",-topDifference-1):(popup.css("marginTop",-topDifference-(popupHeight-visible.realHeight)/2),middle=!0),middle?win.width()>selfOffset.left+popupWidth+selfWidth?popup.css({marginLeft:selfOffset.left-popupOffset.left+selfWidth}):popup.css({marginLeft:selfOffset.left-popupOffset.left-popupWidth}):visible.windowWidth>visible.left+popupWidth?popup.css("marginLeft",leftDifference):popup.css("marginLeft",leftDifference-popupWidth+visible.width)}}}]),_class}()}),sky.service("windows",["templates","callbacks","stackList"],function(_ref){var templates=_ref.templates,callbacks=_ref.callbacks,stackList=_ref.stackList,tips=!1,list=stackList(),windows=this.service={getLast:function(){return list.last()},Modal:function(name,data){if(!(this instanceof windows.Modal))return new windows.Modal(name,data);this.locked=!1,this.background=templates.render("windows-modal",{}).appendTo("#pageContentHolder").data("modalWindow",this),this.dataContainer=this.background.children(),this.holder=this.dataContainer.children(".windowData"),this.closeButton=this.dataContainer.children(".close"),$(document.body).css("overflow","hidden"),this.callbacks=callbacks();try{this.reRender(name,data)}catch(e){throw this.close(!1),e}return this}};windows.Modal.prototype={reRender:function(name,data){return tips&&tips.hideAll(!0),this.holder.html(""),name instanceof jQuery?this.template=name.appendTo(this.holder):"string"==typeof name&&(this.template=templates.render(name,data).appendTo(this.holder)),this},clearExceptTemplate:function(){this.holder.children().detach(),this.holder.append(this.template)},removeMessages:function(){return this.holder.find(".notificationMessage").remove(),this},lock:function(ajax){return this.locked=!0,this.closeButton.hide(),ajax&&ajax.on("preSuccess",function(){this.dataContainer.css("height",this.dataContainer.innerHeight())},this).on("notAbort",function(){var self=this;this.unlock(),this.dataContainer.css("height",this.holder.outerHeight()),setTimeout(function(){self.dataContainer.css("height","")},500)},this).on("abort",function(){this.unlock().close()},this),this},unlock:function(){return this.locked=!1,this.closeButton.show(),this},close:function(){var byUser=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(!this.locked)return this.background.fadeOut("fast",function(){$(this).remove()}),list.remove(this),this.callbacks.fire("close",{byUser:byUser}),tips&&tips.hideAll(!0),list.total()<1&&$(document.body).css("overflow",""),this}};try{tips=sky.service("tips")}catch(e){}$(document).on("keyup",sky.func(function(event){var last=void 0;document.webkitIsFullScreen||document.mozIsFullScreen||document.isFullScreen||27===event.keyCode&&(last=windows.getLast())&&last.close(!0)}))}),sky.action("pagination",{setPage:function(button,_,page){var pagination=button.parents(".pagination").data("pagination");"next"===page&&(page=pagination.current+1),"previous"===page&&(page=pagination.current-1),pagination.goToPage(page)},scrollTo:function(element,event){element.parents(".pagination").data("pagination").scroll(event)},grab:function(runner){var pagination=runner.parents(".pagination").data("pagination");$(window).on("mouseup.pagination",function(){$(window).off("mouseup.pagination mousemove.pagination")}).on("mousemove.pagination",function(event){pagination.scroll(event)})},next:function(button,_){this.setPage(button,_,"next")},previous:function(button,_){this.setPage(button,_,"previous")}}),sky.action("selectReplace",function(_ref){var visibleCalculator=_ref.visibleCalculator;return{filter:function(self,event){var popup=self.closest(".selectReplaceChoose"),inputs=popup.find("input[name]");if(13===event.which){var visible=popup.find("label:visible");0<visible.length&&(inputs.prop("checked",!1),visible.children("input").prop("checked",!0).trigger("change")),event.stopPropagation()}var value=self.val(),rus="йцукенгшщзхъфывапролджэёячсмитьбю",eng="qwertyuiop[]asdfghjkl;'\\zxcvbnm,.",expression=new RegExp(value.toLowerCase()),expressionInvert=new RegExp(value.toLowerCase().replace(/[a-zа-яё]/g,function(character){return-1<rus.indexOf(character)?eng[rus.indexOf(character)]:-1<eng.indexOf(character)?rus[eng.indexOf(character)]:character})),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=inputs[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var input=_step.value;if(input.parent().hasClass("hidden"))return;var inputHtml=input.next().html().toLowerCase();try{inputHtml.match(expression)||inputHtml.match(expressionInvert)?input.parent().show():input.parent().hide()}catch(e){}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},selectAll:function(button){button.closest(".selectReplaceChoose").find(":checkbox:visible").prop("checked",!0).first().trigger("change")},unSelectAll:function(button){button.closest(".selectReplaceChoose").find(":checkbox:visible").prop("checked",!1).first().trigger("change")},close:function(element,event){element.get(0)===event.target&&$(".selectReplaceChoose").addClass("hidden")},drop:function(replace){$(".selectReplaceChoose").addClass("hidden");var popup=replace.next(),dropOffset=visibleCalculator.getDropOffset(replace,popup);dropOffset&&(popup.removeClass("hidden").css({marginLeft:dropOffset.left,margintop:dropOffset.top}),replace.outerWidth()>popup.outerWidth()&&popup.css("width",replace.outerWidth()),popup.find(".search").length&&popup.find(".search input").val("").focus())}}}),sky.directive(".selectReplaceChoose",function(popup,attrs){var change,labels=popup.find("label"),inputs=popup.find("input:radio, input:checkbox"),current=void 0,children=void 0,replace=popup.prev(),val="",defaultValue=replace.html()||"-",defaultAllValue=replace.text()||"Все";replace.data("addItem",function(item){sky.templates.renderByText("{% skyImport forms as forms %}{{ forms.selectReplaceGroup(items, options) }}",{items:[item],options:{name:replace.attr("input"),multiple:!replace.hasClass("single")}}).insertAfter(inputs.filter(":last").parent()),inputs=popup.find("input")}),$(document).on("change",'[data-input="'+attrs["data-input"]+'"] input',change=function(event,data){labels.removeClass("selected"),val="",children=!1;var filtered=inputs.filter(":checked").each(function(){(current=$(this)).closest("label").addClass("selected"),val=(val&&val+", ")+current.next().text(),children=current.next()});26<val.length&&(val=val.substr(0,26).trim()+"..."),filtered.length!==inputs.length||popup.hasClass("single")||(val=defaultAllValue),popup.hasClass("single")&&children?replace.html("").prepend(children.clone().removeClass("name")):children?replace.text(val):replace.html(defaultValue),event&&current&&replace.trigger("change",$.extend(data||{},{value:current.val(),item:$(this)})),popup.hasClass("single")&&$(".selectReplaceChoose").addClass("hidden")}),setTimeout(function(){change(!1)},1)}),$(document).on("click touchstart",function(event){var element=$(event.target||event.srcElement);element.closest(".selectReplaceChoose").length||element.closest(".selectReplace").length||$(".selectReplaceChoose").addClass("hidden")}).on("change",".specialSelect input",function(event){var root=$(this).closest(".specialSelect");root.find(".selected").removeClass("selected"),root.find("input").each(function(){var self=$(this);self.is(":checked")&&self.parent().addClass("selected")})}).on("mouseover",".selectReplaceChoose label",function(){var label=$(this),originalTip=label.find(".checkItemTip");if(originalTip.length&&!label.data("tip")){var popup=label.closest(".selectReplaceChoose"),tip=originalTip.clone().removeClass("hidden").appendTo("body");tip.css({left:popup.offset().left,top:popup.offset().top+popup.outerHeight()+5}),label.data("tip",tip)}}).on("mouseout",".selectReplaceChoose label",function(){var label=$(this);label.data("tip")&&(label.data("tip").remove(),label.removeData("tip"))}),sky.action("suggest",function(suggester){return{adverts:function(input,event){38!=event.keyCode&&40!=event.keyCode&&13!=event.keyCode&&27!=event.keyCode&&(this.suggestAjax&&this.suggestAjax.stop(),""==input.val()||input.val().length<2?suggester.hideAll():this.suggestAjax=sky.ajax("/ajax/members/search",{name:input.val()}).on("success",function(response){response.adverts&&response.adverts.length||suggester.hideAll();var filtered=[];$.each(response.adverts,function(_,advert){filtered.push(advert.username)}),suggester.show(input,filtered)}).on("error",function(){suggester.hideAll()}))},campaigns:function(input,event){38!=event.keyCode&&40!=event.keyCode&&13!=event.keyCode&&27!=event.keyCode&&(this.suggestAjax&&this.suggestAjax.stop(),""==input.val()||input.val().length<2?suggester.hideAll():this.suggestAjax=sky.ajax("/ajax/campaigns/search",{name:input.val()}).on("success",function(response){response.campaigns&&response.campaigns.length||suggester.hideAll();var filtered=[];$.each(response.campaigns,function(_,campaign){filtered.push({html:campaign.name})}),suggester.show(input,filtered)}).on("error",function(){suggester.hideAll()}))},campaignsSpecial:function(input,event){38!=event.keyCode&&40!=event.keyCode&&13!=event.keyCode&&27!=event.keyCode&&(""==input.val()||input.val().length<2?suggester.hideAll():(this.suggestAjax&&this.suggestAjax.stop(),this.suggestAjax=sky.ajax("/ajax/campaigns/search",{name:input.val()}).on("success",function(response){response.campaigns&&response.campaigns.length||suggester.hideAll();var filtered=[];$.each(response.campaigns,function(_,campaign){filtered.push({html:campaign.name+" ("+campaign.advert.username+")",callback:function(){sky.actions.perform(null,null,"page.selectCampaign",[campaign.id])}})}),suggester.show(input,filtered)}).on("error",function(){suggester.hideAll()})))}}}),sky.directive("[data-suggests]",function(element,attributes){element.attr("data-event","keyup: suggest."+attributes["data-suggests"]).attr("autocomplete","off")}),sky.action("tips",{showTip:function(button,_,name){button.data("tip")?button.data("tip").hide():(sky.actions.perform(button,!1,"shared.hideTips",[name]),sky.tips.Tip("bottom",button,{create:$("<div/>").css("overflow","hidden").append($("#"+name+"TipText").html())}).show())},showTipWithText:function(button,_,text){button.data("tip")?button.data("tip").hide():(sky.actions.perform(button,!1,"shared.hideTips"),sky.tips.Tip("bottom",button,{create:$("<div/>").css("overflow","hidden").append(text)}).show())},hideTips:function(element,event){var target=void 0;event&&event.target&&((target=$(event.target)).is("[sky-tip]")||target.is("[sky-tip-text]")||target.closest(".tipContent").length)||sky.tips.hideAll()},forceHideTips:function(){sky.tips.hideAll(!0)}}),sky.directive("[data-tip]",function(button,attributes){var events=attributes["data-event"]||"",event="click: shared.showTip('"+attributes["data-tip"]+"')";events=events?event:events+"; "+event,button.attr("data-event",events).addClass("dashed")}),sky.directive("[data-tip-text]",function(button,attributes){var events=attributes["data-event"]||"",event="click: shared.showTipWithText('"+(attributes["data-tip-hover"]||attributes["data-tip-text"])+"')";events=events?event:events+"; "+event,button.attr("data-event",events).addClass("dashed")}),sky.directive("[data-tip-hover]",function(button,attributes){var tipText=attributes["data-tip-hover"];sky.service("tips").bind(button,"top",{create:tipText});var events=attributes["data-event"]||"",event="click: shared.showTipWithText('"+tipText+"')";events=events?event:events+"; "+event,button.attr("data-event",events).addClass("dashed")}),sky.exec(function(){sky.servicesDeferred.resolve()}),sky.action("shared",{closeWindow:function(self,event){event.target&&event.target===self.get(0)&&self.closest(".windowShadow").data("modalWindow").close()},validForm:function(form){form.validForm()&&form.get(0).submit()},clearForm:function(button,event){var form=button.closest("form");form.get(0).reset(),form.find("input").trigger("change")},changeOrder:function(button,_,orderField,type){var order=button.hasClass("desc")?"asc":"desc",table=button.closest("table"),first=table.find("th:last").parent(),trs=table.find("tr:not(.orderSkip):not(.footer):not(.header)"),cell1=void 0,cell2=void 0,convert="datetime"!==type&&"text"!==type;button.closest("tr").find("a").removeClass("asc desc"),button.addClass(order),trs.sort(function(firstTr,secondTr){if(orderField)cell1=$(firstTr).find("[data-field="+orderField+"]"),cell2=$(secondTr).find("[data-field="+orderField+"]");else{var index=button.closest("tr").find("td, th").index(button.closest("td, th"));cell1=$(firstTr).find("td:eq("+index+")"),cell2=$(secondTr).find("td:eq("+index+")")}var val1=cell1.attr("data-value")||cell1.html(),val2=cell2.attr("data-value")||cell2.html();return convert&&(val1=parseFloat(val1),val2=parseFloat(val2)),val1===val2||convert&&isNaN(val1)&&isNaN(val2)?0:val2<val1||convert&&isNaN(val2)?"desc"===order?1:-1:"desc"===order?-1:1}).insertAfter(first)},changeOrderReload:function(button,_,orderField){var order=button.hasClass("desc")?"asc":"desc";button.closest("tr").find("a").removeClass("asc desc"),button.addClass(order),page.history.set({order:order,orderField:orderField}),page.currentLoader.reload()}}),sky.directive("input.autoHttp",function(input){input.on("focus",function(){""===input.val()&&(input.val("http://").get(0).selectionStart=7)})}),sky.exec(function(){document.body.classList.remove("hidden"),sky.projectDeffered.resolve()});
//# sourceMappingURL=project.js.map
